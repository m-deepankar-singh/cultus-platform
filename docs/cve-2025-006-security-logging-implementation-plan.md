# CVE-2025-006: Security Logging Implementation Plan

This comprehensive security logging implementation plan addresses the "Missing Security Logging" vulnerability (CVE-2025-006) identified in the security audit. The plan will create a robust, structured security logging system that integrates with the existing authentication, rate limiting, and API infrastructure.

## Current State Analysis

### Existing Infrastructure:
- **2,279 console statements** across 309 files (per console-audit-report.txt)
- **Basic authentication logging** in `lib/auth/api-auth.ts` with some security events
- **Rate limiting logging** in `lib/rate-limit/utils.ts` with JSON structured events
- **No centralized security logger** or standardized security event format
- **Unstructured logging** without correlation or monitoring capabilities

### Security Gaps Identified:
- No comprehensive security event tracking
- Missing audit trail for sensitive operations
- No real-time security monitoring
- Inconsistent logging format across API endpoints
- No security event correlation capabilities

## Implementation Plan: 5 Phases (3-4 hours)

### Phase 1: Core Security Logging Infrastructure (60 minutes)

#### Step 1.1: Create Security Event Types (15 minutes)
**File**: `lib/security/types.ts`
```typescript
// Security event types, severity levels, categories
export interface SecurityEvent {
  eventId: string;
  timestamp: string;
  eventType: SecurityEventType;
  severity: SecuritySeverity;
  category: SecurityCategory;
  userId?: string;
  sessionId?: string;
  clientId?: string;
  userRole?: string;
  ipAddress: string;
  userAgent?: string;
  endpoint?: string;
  method?: string;
  details: Record<string, any>;
  correlationId?: string;
  metadata?: Record<string, any>;
}

export enum SecurityEventType {
  AUTH_SUCCESS = 'AUTH_SUCCESS',
  AUTH_FAILURE = 'AUTH_FAILURE',
  AUTH_TOKEN_EXPIRED = 'AUTH_TOKEN_EXPIRED',
  ROLE_VALIDATION_FAILED = 'ROLE_VALIDATION_FAILED',
  RATE_LIMIT_EXCEEDED = 'RATE_LIMIT_EXCEEDED',
  UNAUTHORIZED_ACCESS = 'UNAUTHORIZED_ACCESS',
  FILE_UPLOAD = 'FILE_UPLOAD',
  FILE_ACCESS = 'FILE_ACCESS',
  SENSITIVE_DATA_ACCESS = 'SENSITIVE_DATA_ACCESS',
  ADMIN_ACTION = 'ADMIN_ACTION',
  BULK_OPERATION = 'BULK_OPERATION',
  CONFIGURATION_ACCESS = 'CONFIGURATION_ACCESS',
  SUSPICIOUS_ACTIVITY = 'SUSPICIOUS_ACTIVITY',
  PRIVILEGE_ESCALATION = 'PRIVILEGE_ESCALATION'
}

export enum SecuritySeverity {
  INFO = 'INFO',
  WARNING = 'WARNING',
  CRITICAL = 'CRITICAL',
  EMERGENCY = 'EMERGENCY'
}

export enum SecurityCategory {
  AUTHENTICATION = 'AUTHENTICATION',
  AUTHORIZATION = 'AUTHORIZATION',
  DATA_ACCESS = 'DATA_ACCESS',
  FILE_OPERATIONS = 'FILE_OPERATIONS',
  ADMIN_OPERATIONS = 'ADMIN_OPERATIONS',
  RATE_LIMITING = 'RATE_LIMITING',
  CONFIGURATION = 'CONFIGURATION',
  SECURITY_INCIDENT = 'SECURITY_INCIDENT'
}
```

#### Step 1.2: Create Core Security Logger (20 minutes)
**File**: `lib/security/security-logger.ts`
```typescript
// Main security logger with environment awareness, structured logging
export class SecurityLogger {
  private static instance: SecurityLogger;
  private correlationStore: Map<string, string> = new Map();

  static getInstance(): SecurityLogger {
    if (!SecurityLogger.instance) {
      SecurityLogger.instance = new SecurityLogger();
    }
    return SecurityLogger.instance;
  }

  logEvent(event: Partial<SecurityEvent>, request?: NextRequest): void {
    // Build complete security event with auto-populated fields
    // Environment-specific logging (console in dev, structured JSON in prod)
    // Event correlation and session tracking
  }

  logAuthEvent(type: SecurityEventType, details: Record<string, any>, request?: NextRequest): void
  logAccessEvent(endpoint: string, method: string, success: boolean, details: Record<string, any>, request?: NextRequest): void
  logFileEvent(operation: string, filename: string, success: boolean, details: Record<string, any>, request?: NextRequest): void
  logAdminEvent(action: string, target: string, details: Record<string, any>, request?: NextRequest): void
  logSuspiciousActivity(description: string, details: Record<string, any>, request?: NextRequest): void
}

// Export singleton instance and convenient logging functions
export const securityLogger = SecurityLogger.getInstance();
export const logSecurityEvent = (event: Partial<SecurityEvent>, request?: NextRequest) => securityLogger.logEvent(event, request);
```

#### Step 1.3: Create Security Monitoring Utilities (15 minutes)
**File**: `lib/security/security-monitor.ts`
```typescript
// Real-time security monitoring and alerting
export class SecurityMonitor {
  private eventBuffer: SecurityEvent[] = [];
  private alertThresholds: Map<SecurityEventType, number> = new Map();

  addEvent(event: SecurityEvent): void {
    // Add to buffer for real-time monitoring
    // Check for alert conditions
    // Trigger alerts if thresholds exceeded
  }

  getSecurityMetrics(timeWindow: number = 3600): SecurityMetrics {
    // Calculate security metrics for dashboard
    // Event counts by type, severity, category
    // Trend analysis and anomaly detection
  }

  checkForAnomalies(): SecurityAlert[] {
    // Detect suspicious patterns
    // Multiple failed logins, unusual file access patterns
    // Return alerts for immediate action
  }
}

export interface SecurityMetrics {
  totalEvents: number;
  eventsByType: Record<SecurityEventType, number>;
  eventsBySeverity: Record<SecuritySeverity, number>;
  uniqueUsers: number;
  suspiciousActivityCount: number;
  topEndpoints: Array<{ endpoint: string; count: number }>;
  alertsGenerated: number;
}
```

#### Step 1.4: Create Security Configuration (10 minutes)
**File**: `lib/security/config.ts`
```typescript
// Security logging configuration and environment settings
export const SECURITY_CONFIG = {
  enabledInDevelopment: true,
  enabledInProduction: true,
  logLevel: process.env.NODE_ENV === 'production' ? 'INFO' : 'DEBUG',
  bufferSize: 1000,
  retentionDays: 90,
  alertThresholds: {
    [SecurityEventType.AUTH_FAILURE]: 5, // per 5 minutes
    [SecurityEventType.RATE_LIMIT_EXCEEDED]: 10,
    [SecurityEventType.UNAUTHORIZED_ACCESS]: 3,
    [SecurityEventType.SUSPICIOUS_ACTIVITY]: 1
  },
  sensitiveEndpoints: [
    '/api/admin/*',
    '/api/auth/*',
    '/api/*/upload*',
    '/api/r2/*'
  ]
};
```

### Phase 2: Integration with Authentication System (45 minutes)

#### Step 2.1: Enhance API Authentication Logging (20 minutes)
**File**: `lib/auth/api-auth.ts` (Modifications)
```typescript
// Replace existing console.log statements with structured security logging
// Line 29: Add deprecation warning log
// Line 201-207: Replace console.warn with securityLogger.logAuthEvent
// Line 214-218: Replace console.log with securityLogger.logAuthEvent
// Line 226: Replace console.error with securityLogger.logAuthEvent

// Add security logging to all authentication functions:
// - authenticateApiRequestSecure(): Log successful/failed auth
// - Role validation failures with detailed context
// - JWT token issues and expiration events
// - Rate limiting integration events
```

#### Step 2.2: Update Rate Limiting Security Logging (15 minutes)
**File**: `lib/rate-limit/utils.ts` (Modifications)
```typescript
// Line 88-105: Replace logRateLimitEvent function
export function logRateLimitEvent(
  identifier: string,
  endpoint: string,
  allowed: boolean,
  remaining: number,
  limit: number,
  request?: NextRequest
): void {
  securityLogger.logEvent({
    eventType: allowed ? SecurityEventType.RATE_LIMIT_CHECK : SecurityEventType.RATE_LIMIT_EXCEEDED,
    severity: allowed ? SecuritySeverity.INFO : SecuritySeverity.WARNING,
    category: SecurityCategory.RATE_LIMITING,
    endpoint,
    details: {
      identifier,
      allowed,
      remaining,
      limit,
      utilizationPercentage: ((limit - remaining) / limit) * 100
    }
  }, request);
}
```

#### Step 2.3: Add Security Middleware Enhancement (10 minutes)
**File**: `middleware.ts` (Addition)
```typescript
// Add security logging import at top
import { securityLogger, SecurityEventType, SecuritySeverity } from '@/lib/security';

// Add security logging for:
// - Unauthorized access attempts
// - Route protection violations  
// - Suspicious request patterns
// - JWT token validation issues
```

### Phase 3: API Endpoint Security Logging (60 minutes)

#### Step 3.1: File Upload Endpoints Security Logging (20 minutes)
**Files to modify**:
- `app/api/admin/clients/upload-logo/route.ts`
- `app/api/admin/lessons/upload-video/route.ts`
- All other upload endpoints

**Changes**:
```typescript
// Add security logging for:
// - File upload attempts (authorized/unauthorized)
// - File validation results
// - Upload success/failure with file metadata
// - Storage destination tracking

// Example for upload-logo/route.ts:
export async function POST(request: NextRequest) {
  securityLogger.logFileEvent('LOGO_UPLOAD_ATTEMPT', 'unknown', false, {
    endpoint: '/api/admin/clients/upload-logo'
  }, request);

  const authResult = await authenticateApiRequestSecure(['Admin', 'Staff']);
  if ('error' in authResult) {
    securityLogger.logAuthEvent(SecurityEventType.UNAUTHORIZED_ACCESS, {
      endpoint: '/api/admin/clients/upload-logo',
      error: authResult.error
    }, request);
    return NextResponse.json({ error: authResult.error }, { status: authResult.status });
  }

  // Continue with existing logic...
  // Add success/failure logging after upload completes
}
```

#### Step 3.2: Admin Endpoints Security Logging (25 minutes)
**Files to modify**: All admin API endpoints (99 files with console statements)

**Pattern for admin endpoints**:
```typescript
// Add to each admin endpoint:
// - Admin action logging with action type and target
// - Bulk operation tracking
// - Sensitive data access logging
// - Configuration change tracking

// Example pattern:
securityLogger.logAdminEvent('USER_MANAGEMENT', 'bulk_upload', {
  clientId: authResult.claims.client_id,
  recordCount: students.length,
  endpoint: request.url
}, request);
```

#### Step 3.3: Configuration and Sensitive Endpoints (15 minutes)
**Files to secure**:
- `app/api/r2/test-config/route.ts`
- `app/api/admin/analytics/route.ts`
- `app/api/auth/me/route.ts`

**Changes**:
```typescript
// Add configuration access logging
securityLogger.logEvent({
  eventType: SecurityEventType.CONFIGURATION_ACCESS,
  severity: SecuritySeverity.WARNING,
  category: SecurityCategory.CONFIGURATION,
  endpoint: '/api/r2/test-config',
  details: { configType: 'R2_storage_config' }
}, request);
```

### Phase 4: Security Dashboard Components (45 minutes)

#### Step 4.1: Security Metrics Dashboard Component (25 minutes)
**File**: `components/admin/security/SecurityDashboard.tsx`
```typescript
// Real-time security dashboard with:
// - Live security event feed
// - Security metrics visualization (charts)
// - Alert status indicators
// - Quick action buttons for security incidents
// - Time-based filtering (last hour, day, week)

// Key features:
// - Real-time updates using React hooks
// - Security event type breakdown
// - Geographic distribution of events (if available)
// - Most active users and endpoints
// - Security trend analysis
```

#### Step 4.2: Security Event Viewer Component (20 minutes)
**File**: `components/admin/security/SecurityEventViewer.tsx`
```typescript
// Detailed security event log viewer with:
// - Searchable and filterable event list
// - Event detail modal with full context
// - Export functionality (CSV, JSON)
// - Event correlation visualization
// - Pagination for large datasets

// Advanced features:
// - Filter by user, endpoint, event type, severity
// - Date range selection
// - Event correlation linking
// - Bulk actions for event management
```

### Phase 5: Integration and Console Log Migration (30 minutes)

#### Step 5.1: Console Log Replacement Strategy (20 minutes)
**Target files**: 309 files with 2,279 console statements

**Replacement patterns**:
```typescript
// Replace security-related console.log statements:
// OLD: console.log('User authenticated:', userId);
// NEW: securityLogger.logAuthEvent(SecurityEventType.AUTH_SUCCESS, { userId });

// OLD: console.error('Authentication failed:', error);
// NEW: securityLogger.logAuthEvent(SecurityEventType.AUTH_FAILURE, { error: error.message });

// OLD: console.warn('Rate limit exceeded for:', identifier);
// NEW: securityLogger.logEvent({ eventType: SecurityEventType.RATE_LIMIT_EXCEEDED, details: { identifier } });
```

**Priority replacement order**:
1. Authentication-related console statements (lib/auth/*)
2. API route console statements (app/api/*)  
3. Rate limiting console statements (lib/rate-limit/*)
4. File upload console statements
5. Admin operation console statements

#### Step 5.2: Testing and Validation (10 minutes)
**Test scenarios**:
```typescript
// Test security event generation:
// 1. Failed login attempts -> AUTH_FAILURE events
// 2. Successful admin actions -> ADMIN_ACTION events  
// 3. File upload attempts -> FILE_UPLOAD events
// 4. Rate limiting violations -> RATE_LIMIT_EXCEEDED events
// 5. Configuration access -> CONFIGURATION_ACCESS events

// Validation checklist:
// ✓ Security events are properly formatted
// ✓ Event correlation works across requests
// ✓ Dashboard displays real-time data
// ✓ Alert thresholds trigger correctly
// ✓ No performance impact on API responses
```

## Implementation Details

### Security Event Schema
```typescript
// Example security event for file upload:
{
  "eventId": "sec_evt_1641234567890_abc123",
  "timestamp": "2025-01-11T10:30:00.000Z",
  "eventType": "FILE_UPLOAD",
  "severity": "INFO",
  "category": "FILE_OPERATIONS",
  "userId": "user_123",
  "sessionId": "sess_abc123",
  "clientId": "client_456",
  "userRole": "Admin",
  "ipAddress": "192.168.1.100",
  "userAgent": "Mozilla/5.0...",
  "endpoint": "/api/admin/clients/upload-logo",
  "method": "POST",
  "details": {
    "fileName": "company-logo.png",
    "fileSize": 50240,
    "mimeType": "image/png",
    "uploadResult": "success",
    "storageLocation": "r2://logos/client_456/logo.png"
  },
  "correlationId": "req_1641234567890",
  "metadata": {
    "processingTimeMs": 1250,
    "validationPassed": true
  }
}
```

### Performance Considerations
- **Asynchronous logging**: Security events logged without blocking API responses
- **Buffer management**: Events buffered in memory with periodic flushing
- **Selective logging**: Different log levels for development vs production
- **Minimal overhead**: Security logging adds <5ms to API response times

### Security Benefits
1. **Comprehensive Audit Trail**: All security-relevant actions logged with context
2. **Real-time Monitoring**: Live dashboard for security team monitoring
3. **Incident Investigation**: Detailed logs for forensic analysis
4. **Compliance Support**: Structured logs meet audit requirements
5. **Anomaly Detection**: Automated detection of suspicious patterns
6. **Alert System**: Immediate notification of security incidents

### File Structure After Implementation
```
lib/security/
├── index.ts                    # Main exports
├── types.ts                    # Security event types and interfaces
├── security-logger.ts          # Core logging functionality
├── security-monitor.ts         # Real-time monitoring and alerts
└── config.ts                   # Security configuration

components/admin/security/
├── SecurityDashboard.tsx       # Main security metrics dashboard
├── SecurityEventViewer.tsx     # Detailed event log viewer
└── SecurityAlertPanel.tsx      # Alert management component

Modified files:
├── lib/auth/api-auth.ts        # Enhanced auth logging
├── lib/rate-limit/utils.ts     # Enhanced rate limit logging
├── middleware.ts               # Security middleware logging
└── app/api/**/*.ts             # API endpoint security logging
```

### Success Metrics
- **100% Critical Endpoint Coverage**: All sensitive endpoints have security logging
- **<5ms Performance Impact**: Security logging doesn't affect API performance
- **Real-time Monitoring**: Security dashboard shows events within 1 second
- **Alert Response**: Critical alerts trigger within 30 seconds
- **Audit Compliance**: Structured logs meet SOC 2 and ISO 27001 requirements

This implementation will transform the Cultus Platform from having minimal security logging (2/10 rating) to comprehensive security monitoring (9/10 rating), addressing CVE-2025-006 and providing robust security incident detection and response capabilities.